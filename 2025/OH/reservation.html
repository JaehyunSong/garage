<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宋ゼミ説明会予約システム</title>
    <!-- Tailwind CSS を読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (アイコン用) を読み込み -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* カスタムスタイル */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">宋ゼミオフィスアワー予約システム</h1>
            <p class="text-gray-500 mt-2">宇宙一のゼミへようこそ!</p>

            <div class="mb-10 text-left bg-white border border-gray-200 rounded-lg p-6">
                <h2 class="font-bold text-lg text-gray-800 mb-4 flex items-center"><i class="fas fa-info-circle text-blue-500 mr-3"></i>予約の前にご確認ください</h2>
                <ul class="space-y-3 text-gray-600">
                    <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i><div><strong class="text-gray-800">一つの電話番号につき、一つの予約のみ</strong>有効です。ただし、予約した説明会が終了した場合、もう一度予約可能です。</div></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i><div>重要な通知（場所変更、応募者への課題関連など）のため、<strong class="text-gray-800">普段お使いのメールアドレス</strong>をご登録ください。</div></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i><div><strong class="text-gray-800">数字はすべて半角</strong>でご入力ください。</div></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i><div>友人と参加をご希望の場合も、<strong class="text-gray-800">各自でご予約</strong>をお願いします。</div></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i><div><strong class="text-gray-800">開始1時間前まで予約可能</strong>です。</div></li>
                    <li class="flex items-start"><i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i><div>お問い合わせ: <a href="mailto:song@kansai-u.ac.jp" class="text-blue-500 hover:underline">song@kansai-u.ac.jp</a></div></li>
                </ul>
            </div>
        </header>

        <!-- 予約者向けビュー -->
        <main id="user-view">
            <section class="mb-12">
                <h2 class="text-2xl font-semibold mb-4 border-l-4 border-blue-500 pl-3">開催予定の説明会</h2>
                <div id="events-list" class="space-y-4">
                    <!-- 説明会情報がここに動的に追加されます -->
                    <div class="text-center p-8 bg-white rounded-lg shadow">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                        <p class="mt-2 text-gray-500">説明会を読み込んでいます...</p>
                    </div>
                </div>
            </section>

            <section id="past-events-section" class="mb-12">
                <h2 class="text-2xl font-semibold mb-4 border-l-4 border-gray-500 pl-3">終了した説明会</h2>
                <div id="past-events-list" class="space-y-4">
                    <!-- 終了した説明会がここに表示されます -->
                </div>
            </section>

            <section>
                <h2 class="text-2xl font-semibold mb-4 border-l-4 border-red-500 pl-3">予約の確認・キャンセル</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="mb-4 text-gray-600">予約の確認またはキャンセルを行うには、予約時に登録した電話番号を入力してください。</p>
                    <div>
                        <label for="cancel-phone-number" class="block text-sm font-medium text-gray-700 mb-1">電話番号（ハイフンなし11桁）</label>
                        <input type="tel" id="cancel-phone-number" placeholder="例: 08012349876" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-400 focus:border-red-400 transition">
                    </div>
                    <button id="search-reservation-button" class="mt-4 w-full bg-red-500 text-white font-bold py-3 px-6 rounded-md hover:bg-red-600 transition shadow">
                        <i class="fas fa-search mr-2"></i>予約を検索
                    </button>
                </div>
            </section>

            <section>
                <div class="p-6 text-center">
                    <p class="text-gray-600">© 2025 <a href="https://www.jaysong.net" target="_blank">Jaehyun Song（AIにお願いしたら全部作ってくれた）</a></p>
                </div>
            </section>
        </main>
    </div>

    <!-- モーダル -->
    <div id="modal-container" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <!-- オーバーレイ -->
        <div class="modal-backdrop fixed inset-0"></div>
        <!-- モーダルコンテンツ -->
        <div id="modal-content" class="modal-content relative bg-white rounded-lg shadow-xl w-full max-w-lg animate-fade-in">
            <!-- コンテンツはJSで動的に挿入 -->
        </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script type="module">
        // Firebase SDKのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            deleteDoc, 
            doc,
            updateDoc,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebaseの初期化 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRyXKDLL5XVOI4LK9ZYIBQrqN_YLaGwdY",
            authDomain: "song-zemi.firebaseapp.com",
            projectId: "song-zemi",
            storageBucket: "song-zemi.appspot.com",
            messagingSenderId: "601587502243",
            appId: "1:601587502243:web:209753e356a98fcc34316"
        };
        
        let db, auth;
        let unsubscribeEvents, unsubscribeReservations;
        let allEventsCache = [];

        async function initialize() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.error("Firebaseの構成情報が見つかりません。");
                showAlert("Firebase構成情報がありません", true);
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                onAuthStateChanged(auth, user => {
                    if (user) {
                        subscribeToData();
                    }
                });
                
                await signInAnonymously(auth);

            } catch(e) {
                console.error("Firebaseの初期化に失敗しました: ", e);
                 showAlert("データベースに接続できませんでした。", true);
            }
        }

        // --- DOM要素の取得 ---
        const eventsListContainer = document.getElementById('events-list');
        const pastEventsListContainer = document.getElementById('past-events-list');
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const searchReservationButton = document.getElementById('search-reservation-button');
        const cancelPhoneNumberInput = document.getElementById('cancel-phone-number');

        // --- イベントリスナー ---
        searchReservationButton.addEventListener('click', handleSearchReservation);
        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) closeModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modalContainer.classList.contains('hidden')) {
                closeModal();
            }
        });

        // --- ビュー関連の関数 ---
        function showAlert(message, isError = false) {
            const title = isError ? 'エラー' : '通知';
            const icon = isError ? 'fa-times-circle text-red-500' : 'fa-check-circle text-green-500';
            const buttonColor = isError ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600';

            modalContent.innerHTML = `
                <div class="p-6 text-center relative">
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600" onclick="closeModal()"><i class="fas fa-times text-2xl"></i></button>
                    <i class="fas ${icon} text-4xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">${title}</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button class="w-full ${buttonColor} text-white font-bold py-3 rounded-md transition" onclick="closeModal()">閉じる</button>
                </div>
            `;
            modalContainer.classList.remove('hidden');
        }

        // --- データ購読と描画 ---
        function subscribeToData() {
            if (unsubscribeEvents) unsubscribeEvents();
            if (unsubscribeReservations) unsubscribeReservations();

            const eventsRef = collection(db, 'events');
            const reservationsRef = collection(db, 'reservations');
            
            let allReservations = [];
            
            unsubscribeEvents = onSnapshot(query(eventsRef), (querySnapshot) => {
                allEventsCache = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(allEventsCache, allReservations);
            }, (error) => {
                console.error("説明会データの取得に失敗: ", error);
            });
            
            unsubscribeReservations = onSnapshot(reservationsRef, (querySnapshot) => {
                allReservations = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll(allEventsCache, allReservations);
            }, (error) => {
                console.error("予約データの取得に失敗: ", error);
            });
        }
        
        function renderAll(events, reservations) {
            const now = new Date();
            const upcomingEvents = events.filter(e => new Date(e.endTime) >= now).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            const pastEvents = events.filter(e => new Date(e.endTime) < now).sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            renderUserEventsList(upcomingEvents, reservations);
            renderPastEventsList(pastEvents);
        }

        function renderUserEventsList(events, reservations) {
            if (events.length === 0) {
                eventsListContainer.innerHTML = '<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-gray-500">現在、予約可能な説明会はありません。</p></div>';
                return;
            }

            eventsListContainer.innerHTML = '';
            events.forEach(event => {
                const eventReservations = reservations.filter(r => r.eventId === event.id);
                const remaining = event.capacity - eventReservations.length;
                const isFull = remaining <= 0;
                
                const now = new Date();
                const eventStartTime = new Date(event.startTime);
                const bookingDeadline = new Date(eventStartTime.getTime() - (60 * 60 * 1000));
                const isPastDeadline = now > bookingDeadline;
                
                let statusBadge;
                if (isFull) {
                    statusBadge = `<span class="bg-red-100 text-red-800 text-sm font-medium me-2 px-2.5 py-0.5 rounded">満員</span>`;
                } else if (isPastDeadline) {
                    statusBadge = `<span class="bg-gray-100 text-gray-800 text-sm font-medium me-2 px-2.5 py-0.5 rounded">受付終了</span>`;
                } else if (remaining / event.capacity <= 0.3) {
                    statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-sm font-medium me-2 px-2.5 py-0.5 rounded">残りわずか</span>`;
                } else {
                    statusBadge = `<span class="bg-green-100 text-green-800 text-sm font-medium me-2 px-2.5 py-0.5 rounded">空きあり</span>`;
                }

                let actionAreaHTML;
                if (isPastDeadline) {
                    actionAreaHTML = `<div class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-md text-center">受付終了</div>`;
                } else if (isFull) {
                    actionAreaHTML = `<button class="w-full bg-gray-400 text-white font-bold py-3 px-8 rounded-md cursor-not-allowed" disabled>満員</button>`;
                } else {
                    actionAreaHTML = `<button data-event-id="${event.id}" data-event-info="${escape(JSON.stringify(event))}" class="reserve-button w-full bg-blue-500 text-white font-bold py-3 px-8 rounded-md hover:bg-blue-600 transition shadow">予約する</button>`;
                }
                
                const eventCard = document.createElement('div');
                eventCard.className = 'bg-white p-6 rounded-lg shadow-md transition hover:shadow-lg flex flex-col md:flex-row items-start md:items-center justify-between gap-4';
                eventCard.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center gap-4 mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${formatDateTimeRange(event.startTime, event.endTime)}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-gray-600"><i class="fas fa-map-marker-alt w-5 text-center mr-1 text-blue-500"></i> ${event.location}</p>
                        <p class="text-gray-600"><i class="fas fa-users w-5 text-center mr-1 text-blue-500"></i> 定員: ${event.capacity}名 (残り: ${remaining > 0 ? remaining : 0}名)</p>
                        ${event.description ? `<p class="mt-2 text-sm text-gray-500 bg-gray-50 p-3 rounded-md">${event.description.replace(/\n/g, '<br>')}</p>` : ''}
                    </div>
                    <div class="flex flex-col gap-2 w-full md:w-auto">
                        ${actionAreaHTML}
                    </div>
                `;
                eventsListContainer.appendChild(eventCard);
            });

            document.querySelectorAll('.reserve-button').forEach(button => {
                button.addEventListener('click', (e) => showReservationModal(e.currentTarget.dataset.eventId, JSON.parse(unescape(e.currentTarget.dataset.eventInfo))));
            });
        }
        
        function renderPastEventsList(events) {
            if (events.length === 0) {
                pastEventsListContainer.innerHTML = '<div class="text-center p-8 bg-white rounded-lg shadow"><p class="text-gray-500">終了した説明会はありません。</p></div>';
                return;
            }

            pastEventsListContainer.innerHTML = '';
            events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'bg-white p-6 rounded-lg shadow-md flex flex-col md:flex-row items-start md:items-center justify-between gap-4 opacity-70';
                eventCard.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-500">${formatDateTimeRange(event.startTime, event.endTime)}</h3>
                        <p class="text-gray-500"><i class="fas fa-map-marker-alt w-5 text-center mr-1"></i> ${event.location}</p>
                    </div>
                     <div class="flex flex-col gap-2 w-full md:w-auto">
                        <button class="w-full bg-gray-400 text-white font-bold py-3 px-8 rounded-md cursor-not-allowed" disabled>終了しました</button>
                    </div>
                `;
                pastEventsListContainer.appendChild(eventCard);
            });
        }
        
        // --- モーダル関連の関数 ---
        function showReservationModal(eventId, eventInfo) {
            const now = new Date();
            const eventStartTime = new Date(eventInfo.startTime);
            const bookingDeadline = new Date(eventStartTime.getTime() - (60 * 60 * 1000));
            
            if (now > bookingDeadline) {
                showAlert('この説明会の予約受付は終了しました。', true);
                return; 
            }

            modalContent.innerHTML = `
                <div class="p-6 relative">
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600" onclick="closeModal()"><i class="fas fa-times text-2xl"></i></button>
                    <h3 class="text-2xl font-bold mb-4">予約情報入力</h3>
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                        <p><strong>日時:</strong> ${formatDateTimeRange(eventInfo.startTime, eventInfo.endTime)}</p>
                        <p><strong>場所:</strong> ${eventInfo.location}</p>
                    </div>
                    <form id="reservation-form">
                        <input type="hidden" id="event-id" value="${eventId}">
                        <div class="space-y-4">
                            <div><label for="name" class="block mb-1 font-medium">氏名 (漢字; 漢字名がない場合は英字名)</label><input type="text" id="name" placeholder="例: 関大太郎" class="w-full p-2 border border-gray-300 rounded-md" required></div>
                            <div><label for="name-kana" class="block mb-1 font-medium">氏名（読み方）</label><input type="text" id="name-kana" placeholder="例: かんだい たろう" class="w-full p-2 border border-gray-300 rounded-md" required></div>
                            <div>
                                <label for="student-id-prefix" class="block mb-1 font-medium">学籍番号</label>
                                <div class="flex items-center">
                                    <span class="inline-flex items-center px-3 text-sm text-gray-900">情</span>
                                    <input type="text" id="student-id-prefix" placeholder="24" class="w-16 p-2 border border-gray-300 rounded-md" required>
                                    <span class="inline-flex items-center px-3 text-sm text-gray-900">-</span>
                                    <input type="text" id="student-id-suffix" placeholder="0123" class="w-full p-2 border border-gray-300 rounded-md" required>
                                </div>
                            </div>
                            <div><label for="email" class="block mb-1 font-medium">メールアドレス（普段使用するメールアドレス）</label><input type="email" id="email" placeholder="例: t123456@kansai-u.ac.jp" class="w-full p-2 border border-gray-300 rounded-md" required></div>
                            <div><label for="phone-number" class="block mb-1 font-medium">携帯電話番号 (ハイフンなし11桁)</label><input type="tel" id="phone-number" placeholder="例: 08012349876" class="w-full p-2 border border-gray-300 rounded-md" required></div>
                            <div class="mb-4 p-3 bg-yellow-50 rounded-lg text-sm">
                                <p><strong>※注意:</strong> 予約の確認・キャンセル時に電話番号が必要になりますので、お間違えのないようご入力ください。</p>
                            </div>
                            <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-md hover:bg-blue-600 transition">予約を確定する</button>
                        </div>
                    </form>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            document.getElementById('reservation-form').addEventListener('submit', handleAddReservation);
        }
        
        function showCancelConfirmationModal(reservation) {
            const eventInfo = allEventsCache.find(e => e.id === reservation.eventId);
            modalContent.innerHTML = `
                 <div class="p-6 relative">
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600" onclick="closeModal()"><i class="fas fa-times text-2xl"></i></button>
                    <h3 class="text-2xl font-bold mb-4">予約内容の確認</h3>
                    <p class="mb-4">以下の予約が見つかりました。キャンセルしますか？</p>
                    <div class="mb-6 p-4 bg-gray-100 rounded-lg">
                        <p><strong>日時:</strong> ${eventInfo ? formatDateTimeRange(eventInfo.startTime, eventInfo.endTime) : '情報なし'}</p>
                        <p><strong>場所:</strong> ${eventInfo ? eventInfo.location : '情報なし'}</p>
                        <p><strong>予約者名:</strong> ${reservation.name}</p>
                        <p><strong>学籍番号:</strong> ${reservation.studentId}</p>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-400" onclick="closeModal()">閉じる</button>
                        <button id="confirm-cancel-button" data-reservation-id="${reservation.id}" class="bg-red-500 text-white font-bold py-2 px-6 rounded-md hover:bg-red-600">はい、キャンセルします</button>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            document.getElementById('confirm-cancel-button').addEventListener('click', (e) => handleCancelReservation(e.currentTarget.dataset.reservationId));
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
            modalContent.innerHTML = '';
        }

        // --- データ操作ハンドラ ---
        async function handleAddReservation(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#name').value.trim();
            const nameKana = form.querySelector('#name-kana').value.trim();
            const studentIdPrefix = form.querySelector('#student-id-prefix').value.trim();
            const studentIdSuffix = form.querySelector('#student-id-suffix').value.trim();
            const email = form.querySelector('#email').value.trim();
            const phoneNumber = form.querySelector('#phone-number').value.trim();
            const eventId = form.querySelector('#event-id').value;
            
            const studentId = `情${studentIdPrefix}-${studentIdSuffix}`;

            // Validation
            const studentIdRegex = /^情\d{2}-\d{1,4}$/;
            if (!studentIdRegex.test(studentId)) {
                showAlert('学籍番号は「情XX-YYYY」の形式で入力してください。', true); return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showAlert('有効なメールアドレスを入力してください。', true); return;
            }
            if (!/^\d{11}$/.test(phoneNumber)) {
                showAlert('電話番号はハイフンなしの11桁で入力してください。', true); return;
            }

            const reservationData = { eventId, name, nameKana, studentId, email, phoneNumber, createdAt: serverTimestamp() };
            
            try {
                const reservationsRef = collection(db, 'reservations');
                
                // 重複予約チェック
                const qPhone = query(reservationsRef, where("phoneNumber", "==", phoneNumber));
                const phoneSnapshot = await getDocs(qPhone);
                let hasActiveReservation = false;
                if (!phoneSnapshot.empty) {
                    for(const resDoc of phoneSnapshot.docs) {
                        const reservedEvent = allEventsCache.find(e => e.id === resDoc.data().eventId);
                        if (reservedEvent && new Date(reservedEvent.endTime) >= new Date()) {
                            hasActiveReservation = true; break;
                        }
                    }
                }
                if (hasActiveReservation) {
                    showAlert('この電話番号は既に有効な予約があります。', true); return;
                }
                
                // 定員チェック
                const qCapacity = query(reservationsRef, where("eventId", "==", eventId));
                const capacitySnapshot = await getDocs(qCapacity);
                const event = allEventsCache.find(e => e.id === eventId);
                if (capacitySnapshot.size >= (event?.capacity || 0)) {
                    showAlert('申し訳ありません、この説明会は満員になりました。', true);
                    closeModal(); return;
                }

                await addDoc(reservationsRef, reservationData);
                showAlert('予約が完了しました。');
                closeModal();
            } catch(error) {
                 console.error("予約に失敗: ", error);
                 showAlert('予約に失敗しました。', true);
            }
        }

        async function handleSearchReservation() {
            const phoneNumber = cancelPhoneNumberInput.value.trim();
            if (!/^\d{11}$/.test(phoneNumber)) {
                showAlert('電話番号はハイフンなしの11桁で入力してください。', true); return;
            }

            try {
                const q = query(collection(db, 'reservations'), where("phoneNumber", "==", phoneNumber));
                const querySnapshot = await getDocs(q);

                let foundReservation = null;
                for(const resDoc of querySnapshot.docs) {
                    const event = allEventsCache.find(e => e.id === resDoc.data().eventId);
                    if (event && new Date(event.endTime) >= new Date()) {
                        foundReservation = { id: resDoc.id, ...resDoc.data() };
                        break;
                    }
                }

                if (foundReservation) {
                    showCancelConfirmationModal(foundReservation);
                } else {
                    showAlert('有効な予約が見つかりませんでした。', true);
                }
            } catch (error) {
                console.error("予約の検索に失敗: ", error);
                showAlert('予約の検索中にエラーが発生しました。', true);
            }
        }

        async function handleCancelReservation(reservationId) {
            try {
                await deleteDoc(doc(db, 'reservations', reservationId));
                showAlert('予約をキャンセルしました。');
                closeModal();
                cancelPhoneNumberInput.value = '';
            } catch(error) {
                console.error("予約のキャンセルに失敗: ", error);
                showAlert('キャンセルに失敗しました。', true);
            }
        }

        // --- ユーティリティ関数 ---
        function formatDateTimeRange(isoStart, isoEnd) {
            try {
                const startDate = new Date(isoStart);
                const endDate = new Date(isoEnd);
                const optionsDate = { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'short' };
                const optionsTime = { hour: '2-digit', minute: '2-digit' };
                const dateStr = new Intl.DateTimeFormat('ja-JP', optionsDate).format(startDate);
                const startTimeStr = new Intl.DateTimeFormat('ja-JP', optionsTime).format(startDate);
                const endTimeStr = new Intl.DateTimeFormat('ja-JP', optionsTime).format(endDate);
                return `${dateStr} ${startTimeStr} - ${endTimeStr}`;
            } catch(e) {
                return '日時形式エラー';
            }
        }
        
        // グローバルスコープに関数を公開
        window.closeModal = closeModal;
        // --- 初期化処理の実行 ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
